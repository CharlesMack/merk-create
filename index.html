<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
    <title>Merk Creative Kit - On-Set Tools</title>
    <style>
        /* Base styles adapted from P.O.P.S. */
        :root {
            --bg: #0a0d14;
            --glass1: rgba(14, 20, 34, .66);
            --glass2: rgba(14, 20, 34, .28);
            --rim: #1e2a45;
            --accent: #7af0ff;
            --accent-2: #00e5ff;
            --warn: #ffcc00;
            --danger: #ff3355;
            --fg: #eaf0ff;
            --muted: #9aacbf;
            --ok: #4ade80;
        }

        * {
            box-sizing: border-box
        }

        html, body {
            height: 100%
        }

        body {
            margin: 0;
            background: radial-gradient(1200px 800px at 30% 0%, #0e1628 0%, #0a0d14 50%, #06080f 100%);
            color: var(--fg);
            font: 500 12px/1.25 system-ui, Inter, Segoe UI, Roboto, Arial;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .wrap {
            display: grid;
            grid-template-rows: auto 1fr auto;
            height: 100vh;
            gap: 10px;
            padding: 12px;
        }

        .glass {
            background: linear-gradient(180deg, var(--glass1), var(--glass2));
            border: 1px solid rgba(122, 240, 255, .18);
            backdrop-filter: blur(10px);
            border-radius: 14px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, .35);
        }

        .topbar {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            padding: 8px 12px;
            gap: 10px;
        }

        .brand {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .chip {
            display: inline-flex;
            gap: 6px;
            align-items: center;
            padding: 6px 10px;
            border: 1px solid var(--rim);
            border-radius: 12px;
            background: linear-gradient(180deg, #141a2b, #0f1525);
        }

        .stat {
            opacity: .9
        }

        .mid {
            display: grid;
            grid-template-columns: 260px 1fr 320px;
            gap: 10px;
            min-height: 0;
        }
        
        .panel {
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-height: 0;
        }

        .section {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .section h3 {
            margin: 0 0 6px 0;
            font-weight: 700;
            letter-spacing: .02em;
            color: #c7d2fe;
        }

        .row {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        select, input[type="number"], button {
            background: #0e172a;
            color: var(--fg);
            border: 1px solid var(--rim);
            padding: 6px 8px;
            border-radius: 10px;
            font: inherit;
        }

        button {
            cursor: pointer;
        }

        button.prim {
            border-color: var(--accent);
            box-shadow: 0 0 0 1px rgba(122, 240, 255, .2) inset;
        }

        button.rec {
            background: linear-gradient(180deg, #3b0b18, #1a0911);
            border-color: #6b0d22;
        }

        button.rec.live {
            background: linear-gradient(180deg, #ff3355, #a80e2d);
            color: white;
            border-color: #ff3355;
            box-shadow: 0 0 12px rgba(255, 51, 85, .5);
        }

        .meter {
            height: 8px;
            border-radius: 999px;
            background: #0e172a;
            border: 1px solid var(--rim);
            overflow: hidden;
        }

        .meter > span {
            display: block;
            height: 100%;
            background: linear-gradient(90deg, var(--accent), #18e7ff);
        }

        /* Viewfinder */
        .vf {
            position: relative;
            overflow: hidden;
            border-radius: 14px;
            border: 1px solid var(--rim);
            background: #000;
        }
        
        .vf .feed {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 1;
        }

        .vf .test {
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, #f00, #ff0, #0f0, #0ff, #00f, #f0f, #f00);
        }

        /* Overlays */
        .vf .overlay {
            position: absolute;
            inset: 0;
            pointer-events: none;
        }

        .vf .ghost-frame {
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center;
            opacity: 0.5;
            z-index: 2;
        }

        .vf .shot-planner {
            position: absolute;
            inset: 0;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 100 100" preserveAspectRatio="none"><rect x="0" y="0" width="49%" height="100%" fill="none" stroke="rgba(255,255,255,0.4)" stroke-width="0.5"/><rect x="51%" y="0" width="49%" height="100%" fill="none" stroke="rgba(255,255,255,0.4)" stroke-width="0.5"/></svg>');
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 2;
        }
        
        .vf .shot-planner.active {
            opacity: 1;
        }

        .vf .frame-guides {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 5;
        }

        .vf .safe {
            position: absolute;
            inset: 6% 7%;
            border: 1px solid rgba(255, 255, 255, .24);
        }

        .vf .letterbox {
            position: absolute;
            left: 0;
            right: 0;
            background: #000;
            opacity: .85;
        }

        .vf .letterbox.top {
            top: 0;
        }

        .vf .letterbox.bot {
            bottom: 0;
        }

        .vf .nd {
            position: absolute;
            inset: 0;
            background: #000;
            opacity: 0;
            pointer-events: none;
            z-index: 2; 
        }

        .vf .tc {
            position: absolute;
            bottom: 10px;
            left: 12px;
            background: rgba(0, 0, 0, .5);
            padding: 4px 8px;
            border-radius: 8px;
            font-weight: 700;
            z-index: 5;
        }

        .vf .badge {
            position: absolute;
            top: 10px;
            left: 12px;
            display: flex;
            gap: 6px;
            z-index: 5;
        }

        .vf .badge .b {
            padding: 4px 8px;
            border-radius: 8px;
            background: rgba(0, 0, 0, .55);
            border: 1px solid rgba(255, 255, 255, .15);
        }
        
        .vf .flare {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 3;
            mix-blend-mode: screen;
            opacity: 0;
        }
        
        .vf .flare.on {
            opacity: 1;
            transition: opacity 0.5s;
        }

        /* Panels */
        .kv {
            display: grid;
            grid-template-columns: 110px 1fr;
            gap: 8px;
            align-items: center;
        }

        .vslider {
            height: 160px;
            display: flex;
            gap: 10px;
        }

        .vslider input[type="range"] {
            -webkit-appearance: none;
            width: 20px;
            height: 160px;
            writing-mode: vertical-lr;
            direction: rtl;
            background: transparent;
            outline: none;
        }

        .vslider input[type="range"]::-webkit-slider-runnable-track {
            background: linear-gradient(180deg, #101a2f, #0b1121);
            border: 1px solid var(--rim);
            width: 6px;
            border-radius: 999px;
        }

        .vslider input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: radial-gradient(circle at 35% 35%, #fff, #bdf4ff 60%, #10c8e8 61%);
            margin-top: -6px;
            border: 1px solid #0bbbd8;
            box-shadow: 0 0 10px rgba(16, 200, 232, .6);
        }
        
        .foot {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            gap: 10px;
        }

        .foot .left, .foot .right {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .badge2 {
            padding: 6px 10px;
            border-radius: 10px;
            border: 1px solid var(--rim);
            background: rgba(14, 20, 34, .6);
        }

        .roger {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .roger button {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            display: grid;
            place-items: center;
        }

        .mic.on {
            border-color: var(--ok);
            box-shadow: 0 0 12px rgba(74, 222, 128, .5);
        }
        
        .bin {
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow: auto;
            min-height: 140px;
            border-top: 1px dashed rgba(122, 240, 255, .25);
            padding-top: 8px;
        }

        .take {
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 8px;
            align-items: center;
            border: 1px solid var(--rim);
            border-radius: 10px;
            padding: 6px 8px;
            background: rgba(10, 13, 20, .55);
        }

        .take .meta {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .take video {
            max-width: 160px;
            border: 1px solid var(--rim);
            border-radius: 8px;
        }

        @media (max-width: 1100px) {
            .mid {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr auto;
            }
        }
        
        .hidden-file-input {
            display: none;
        }

    </style>
</head>
<body>
    <div class="wrap">
        <!-- TOP BAR -->
        <div class="topbar glass">
            <div class="brand">
                <div class="chip"><strong>Merk Creative</strong> <span class="stat">Lens Simulator</span></div>
                <div class="chip">Project: <span id="projName">Untitled</span></div>
                <div class="chip">Clip: <span id="clipId">A001_C001</span></div>
            </div>
            <div class="row" style="justify-content:center">
                <div class="chip">Res:
                    <select id="resSel">
                        <option>4.6K</option>
                        <option>4K</option>
                        <option>3.3K</option>
                        <option>3K</option>
                        <option>2.7K</option>
                        <option>2K</option>
                    </select>
                </div>
                <div class="chip">FPS:
                    <select id="fpsSel">
                        <option>24</option>
                        <option>25</option>
                        <option>30</option>
                        <option>48</option>
                        <option>60</option>
                        <option>120</option>
                        <option>600</option>
                    </select>
                </div>
                <div class="chip">Aspect:
                    <select id="aspSel">
                        <option>16:9</option>
                        <option selected>2.39:1</option>
                        <option>4:3</option>
                    </select>
                </div>
                <div class="chip">Guides: <label><input id="guides" type="checkbox" checked> On</label></div>
                <button id="useCam" class="prim">Use Camera</button>
            </div>
            <div style="display:flex; justify-content:flex-end; gap:8px; align-items:center">
                <div class="chip">Slices:
                    <span class="stat">HOT <b id="hotPct">62%</b></span> •
                    <span class="stat">WARM <b id="warmPct">15%</b></span> •
                    <span class="stat">COLD <b id="coldTB">3.0TB</b> free</span>
                </div>
            </div>
        </div>

        <!-- MID -->
        <div class="mid">
            <!-- LEFT PANEL -->
            <div class="panel glass">
                <div class="section">
                    <h3>Lens & Focus</h3>
                    <div class="kv"><div>Focal Length</div>
                        <div class="row">
                            <select id="focalLengthSel">
                                <option value="24">24mm (Wide)</option>
                                <option value="50">50mm (Normal)</option>
                                <option value="85">85mm (Telephoto)</option>
                            </select>
                        </div>
                    </div>
                    <div class="kv"><div>Aperture (F-Stop)</div>
                        <div class="row">
                            <input id="aperture" type="number" min="1.4" max="22" step="0.1" value="2.8" style="width:70px"> f/
                        </div>
                    </div>
                </div>
                <div class="section">
                    <h3>Merk Looks</h3>
                    <div class="kv"><div>Look</div>
                        <select id="lookSel">
                            <option value="classic">Merk Classic</option>
                            <option value="filmic">Merk Filmic</option>
                            <option value="raw">Log / Raw</option>
                        </select>
                    </div>
                    <div class="kv"><div>Texture</div>
                        <select id="texSel"><option>Neutral</option><option>Soft</option><option>Gritty</option><option>Dream</option></select>
                    </div>
                    <div class="kv"><div>White Balance</div>
                        <div class="row" style="flex:1">
                            <input id="wbKel" type="number" min="2000" max="10000" step="100" value="5600" style="width:90px">
                            <button data-wb="3200">3200K</button>
                            <button data-wb="5600">5600K</button>
                            <button data-wb="6500">6500K</button>
                        </div>
                    </div>
                </div>
                <div class="section">
                    <h3>Creative Tools</h3>
                    <div class="row">
                        <label><input id="ghostFrameChk" type="checkbox"> Ghost Frame™</label>
                        <button id="captureGhost">Capture Ghost</button>
                    </div>
                    <div class="row">
                        <label><input id="shotPlannerChk" type="checkbox"> Shot Planner</label>
                    </div>
                </div>
            </div>

            <!-- VIEWFINDER -->
            <div class="vf glass" id="vf">
                <video id="cam" class="feed" playsinline muted></video>
                <div class="overlay ghost-frame" id="ghostFrame"></div>
                <div class="overlay shot-planner" id="shotPlanner"></div>
                <div class="test feed" id="testPattern"></div>
                <div class="bars" id="peaking"></div>
                <div class="grain" id="grain"></div>
                <div class="nd" id="ndOverlay"></div>
                <div class="flare" id="flareOverlay"></div>
                <div class="frame-guides" id="guidesBox">
                    <div class="safe"></div>
                    <div class="letterbox top" id="lbTop" style="height:0"></div>
                    <div class="letterbox bot" id="lbBot" style="height:0"></div>
                </div>
                <div class="badge">
                    <div class="b" id="bFps">24fps</div>
                    <div class="b" id="bRes">4.6K</div>
                    <div class="b" id="bFocal">50mm</div>
                    <div class="b" id="bISO">EI 800</div>
                    <div class="b" id="bShut">180°</div>
                    <div class="b" id="bAna">Anamorphic: Off</div>
                    <div class="b" id="bLook">Classic</div>
                </div>
                <div class="tc" id="timecode">00:00:00:00</div>
            </div>

            <!-- RIGHT PANEL: Lens/Power + TAKE BIN -->
            <div class="panel glass">
                <div class="section">
                    <h3>Exposure & Camera</h3>
                    <div class="kv"><div>ISO (EI)</div>
                        <div class="row"><button class="decIso">−</button><input id="iso" type="number" step="100" min="160" max="6400" value="800" style="width:90px"><button class="incIso">+</button></div>
                    </div>
                    <div class="kv"><div>Shutter Angle</div>
                        <div class="row"><button class="decSh">−</button><input id="shutter" type="number" step="5" min="45" max="360" value="180" style="width:90px"><button class="incSh">+</button></div>
                    </div>
                    <div class="kv"><div>Anamorphic</div>
                        <select id="anaSel"><option value="1">Off</option><option value="1.3">1.3×</option><option value="2">2.0×</option></select>
                    </div>
                    <div class="kv"><div>Focus Peaking</div><label><input id="peakChk" type="checkbox"> On (overlay)</label></div>
                    <div class="kv"><div>Lens Flare</div><label><input id="flareChk" type="checkbox"> On (anamorphic)</label></div>
                    <div class="section"><h3>Exposure Meter</h3><div class="kv"><div>EV Offset</div><div id="evText">0.0</div></div></div>
                </div>
                <div class="section">
                    <h3>Storage & Power</h3>
                    <div>Battery (B-Mount 24V)</div>
                    <div class="meter"><span id="batBar" style="width:85%"></span></div>
                    <div class="row"><span id="batText">85%</span> • <span id="volt">24.0V</span></div>
                    <div style="margin-top:6px">HOT Cache</div>
                    <div class="meter"><span id="hotBar" style="width:62%"></span></div>
                    <div style="margin-top:6px">WARM Archive</div>
                    <div class="meter"><span id="warmBar" style="width:15%"></span></div>
                </div>
                <div class="section">
                    <h3>🎬 Take Bin</h3>
                    <div class="row">
                        <button id="chooseDir" class="prim" title="Optional: save takes directly into a folder">Set Save Folder</button>
                        <button id="clearBin">Clear Bin</button>
                    </div>
                    <div id="takeList" class="bin"></div>
                </div>
            </div>
        </div>

        <!-- FOOTER -->
        <div class="foot glass">
            <div class="left">
                <button id="recBtn" class="rec">● REC</button>
                <div class="badge2">Take <b id="takeNo">1</b></div>
                <div class="badge2">Slate: <span id="slate">INT LAB / DAY</span></div>
                <div class="badge2">Shortcuts: R (rec), A (anamorphic), L (LUT), ←/→ FPS, ↑/↓ ISO</div>
            </div>
            <div class="roger">
                <button id="micBtn" class="mic" title="Voice (Web Speech)">🎙</button>
                <div class="badge2" id="voiceStatus">Roger: idle</div>
            </div>
            <div class="right">
                <button id="resetBtn">Reset</button>
                <button id="saveBtn" class="prim">Save Settings</button>
            </div>
        </div>
    </div>

    <script>
        /* ---------- Base State ---------- */
        const S = {
            res: '4.6K', fps: 24, aspect: '2.39:1',
            look: 'classic', texture: 'Neutral', wb: 5600,
            iso: 800, shutter: 180, anamorphic: 1,
            focalLength: 50,
            recording: false, tc: { h: 0, m: 0, s: 0, f: 0 }, take: 1,
            battery: 85, hot: 62, warm: 15, coldTB: 3.0
        };
        const els = {
            resSel: $('#resSel'), fpsSel: $('#fpsSel'), aspSel: $('#aspSel'), guides: $('#guides'),
            useCam: $('#useCam'), cam: $('#cam'), test: $('#testPattern'), vf: $('#vf'),
            bFps: $('#bFps'), bRes: $('#bRes'), bISO: $('#bISO'), bShut: $('#bShut'), bAna: $('#bAna'), bLook: $('#bLook'),
            bFocal: $('#bFocal'),
            lookSel: $('#lookSel'), texSel: $('#texSel'), wbKel: $('#wbKel'),
            focalLengthSel: $('#focalLengthSel'),
            ghostFrameChk: $('#ghostFrameChk'), shotPlannerChk: $('#shotPlannerChk'),
            captureGhost: $('#captureGhost'), ghostFrame: $('#ghostFrame'), shotPlanner: $('#shotPlanner'),
            peaking: $('#peaking'), grain: $('#grain'),
            lbTop: $('#lbTop'), lbBot: $('#lbBot'), guidesBox: $('#guidesBox'),
            timecode: $('#timecode'), recBtn: $('#recBtn'), takeNo: $('#takeNo'),
            iso: $('#iso'), shutter: $('#shutter'), anaSel: $('#anaSel'), flareChk: $('#flareChk'), peakChk: $('#peakChk'),
            evText: $('#evText'), batBar: $('#batBar'), batText: $('#batText'), volt: $('#volt'),
            hotBar: $('#hotBar'), warmBar: $('#warmBar'),
            hotPct: $('#hotPct'), warmPct: $('#warmPct'), coldTB: $('#coldTB'),
            projName: $('#projName'), clipId: $('#clipId'),
            micBtn: $('#micBtn'), voiceStatus: $('#voiceStatus'),
            resetBtn: $('#resetBtn'), saveBtn: $('#saveBtn'),
            takeList: $('#takeList'), chooseDir: $('#chooseDir'), clearBin: $('#clearBin'),
            flareOverlay: $('#flareOverlay')
        };
        function $(q) { return document.querySelector(q) }
        function clamp(n, min, max) { return Math.max(min, Math.min(max, n)) }
        function tcStr() { const z = n => String(n).padStart(2, '0'); return `${z(S.tc.h)}:${z(S.tc.m)}:${z(S.tc.s)}:${z(S.tc.f)}` }

        /* ---------- Lens Effects & Overlays with CSS Filters ---------- */
        const LOOKS = {
            'classic': 'contrast(1.15) saturate(1.05)',
            'filmic': 'contrast(1.22) saturate(1.18) hue-rotate(2deg)',
            'raw': 'contrast(1.0) saturate(.9) brightness(1.0)',
        };

        function updateVisuals() {
            // Lens & Color effects
            const lookFilter = LOOKS[S.look] || LOOKS['classic'];
            const wbFilter = `hue-rotate(${(S.wb - 5600) / 60}deg)`;
            
            const zoomLevel = S.focalLength / 50; 
            
            els.cam.style.transform = `scale(${zoomLevel}) scaleX(${S.anamorphic})`;
            els.cam.style.filter = `${lookFilter} ${wbFilter}`;

            // Overlays
            els.bLook.textContent = S.look.charAt(0).toUpperCase() + S.look.slice(1);
            els.bFocal.textContent = S.focalLength + 'mm';
            els.bAna.textContent = `Anamorphic: ${S.anamorphic === 1 ? 'Off' : S.anamorphic + 'x'}`;
            
            els.shotPlanner.classList.toggle('active', els.shotPlannerChk.checked);
            els.ghostFrame.style.display = els.ghostFrameChk.checked ? 'block' : 'none';

            applyFlare();
            applyAspect();
            applyTexture();
            updateExposure();
            refreshBadges();
        }

        function applyTexture() {
            const t = S.texture;
            let op = .22, blur = 0;
            if (t === 'Soft') { op = .12; blur = .4 }
            if (t === 'Gritty') { op = .35 }
            if (t === 'Dream') { op = .18; blur = 1 }
            els.grain.style.opacity = op;
            els.grain.style.filter = `blur(${blur}px)`;
        }

        function buildGrain() {
            const c = document.createElement('canvas');
            const s = 256;
            c.width = c.height = s;
            const ctx = c.getContext('2d');
            const img = ctx.createImageData(s, s);
            for (let i = 0; i < img.data.length; i += 4) {
                const v = Math.random() * 255;
                img.data[i] = img.data[i + 1] = img.data[i + 2] = v;
                img.data[i + 3] = 40;
            }
            ctx.putImageData(img, 0, 0);
            els.grain.style.background = `url(${c.toDataURL()}) center/auto repeat`;
        }
        
        function applyFlare() {
            const isAnamorphic = S.anamorphic > 1;
            els.flareOverlay.classList.toggle('on', isAnamorphic && els.flareChk.checked);
        }

        function applyAspect() {
            const rect = els.vf.getBoundingClientRect();
            const w = rect.width, h = rect.height;
            const target = S.aspect === '2.39:1' ? (w / 2.39) : (S.aspect === '4:3' ? (w * 3 / 4) : (w * 9 / 16));
            const bar = clamp((h - target) / 2, 0, h / 2);
            els.lbTop.style.height = els.guides.checked ? `${bar}px` : '0';
            els.lbBot.style.height = els.guides.checked ? `${bar}px` : '0';
        }

        function computeEV() {
            const isoStop = Math.log2(S.iso / 800);
            const shStop = Math.log2(180 / S.shutter);
            return isoStop + shStop;
        }

        function updateExposure() {
            const ev = computeEV();
            els.evText.textContent = ev.toFixed(2) + ' EV';
            const pct = clamp(50 + ev * 8, 0, 100);
        }

        function refreshBadges() {
            els.bFps.textContent = S.fps + 'fps';
            els.bRes.textContent = S.res;
            els.bISO.textContent = 'EI ' + S.iso;
            els.bShut.textContent = S.shutter + '°';
            els.bFocal.textContent = S.focalLength + 'mm';
            els.bAna.textContent = `Anamorphic: ${S.anamorphic === 1 ? 'Off' : S.anamorphic + 'x'}`;
            els.bLook.textContent = S.look.charAt(0).toUpperCase() + S.look.slice(1);
        }

        /* ---------- Timecode ---------- */
        let tcTimer = null;
        function stepTC() {
            const fps = Number(S.fps);
            S.tc.f++;
            if (S.tc.f >= fps) { S.tc.f = 0; S.tc.s++ }
            if (S.tc.s >= 60) { S.tc.s = 0; S.tc.m++ }
            if (S.tc.m >= 60) { S.tc.m = 0; S.tc.h++ }
            els.timecode.textContent = tcStr();
        }

        /* ---------- Battery & Slices Sim ---------- */
        function tickPower() {
            if (S.recording) {
                S.battery = Math.max(0, S.battery - 0.02);
                if (S.hot < 95) S.hot += 0.01;
            }
            els.batBar.style.width = S.battery.toFixed(2) + '%';
            els.batText.textContent = S.battery.toFixed(0) + '%';
            els.volt.textContent = (22 + (S.battery / 100) * 2.6).toFixed(1) + 'V';
            els.hotBar.style.width = S.hot.toFixed(2) + '%';
            els.warmBar.style.width = S.warm.toFixed(2) + '%';
            els.hotPct.textContent = S.hot.toFixed(0) + '%';
            els.warmPct.textContent = S.warm.toFixed(0) + '%';
            els.coldTB.textContent = S.coldTB.toFixed(1) + 'TB';
        }
        setInterval(tickPower, 250);

        /* ---------- Camera / MediaRecorder ---------- */
        let stream = null, recorder = null, chunks = [];
        let saveDirHandle = null;
        let takes = [];

        function bestMime() {
            const cand = ['video/webm;codecs=vp9,opus', 'video/webm;codecs=vp8,opus', 'video/webm'];
            return cand.find(t => MediaRecorder.isTypeSupported?.(t)) || 'video/webm';
        }

        async function enableCam() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: true });
                els.cam.srcObject = stream;
                await els.cam.play();
                els.test.style.display = 'none';
                els.cam.style.visibility = 'visible';
                els.useCam.textContent = 'Camera On';
            } catch (e) {
                console.error('Camera access failed:', e);
                // Fallback to test pattern and inform user
                els.test.style.display = 'block';
                els.cam.style.visibility = 'hidden';
                els.useCam.textContent = 'Camera Failed';
                els.useCam.disabled = true;
                alert('Camera access failed: ' + e.message);
            }
        }

        async function chooseDir() {
            if (!window.showDirectoryPicker) { console.error('Your browser does not support choosing a save folder.'); return; }
            try {
                saveDirHandle = await window.showDirectoryPicker();
            } catch (e) { if (e.name !== 'AbortError') console.error('Folder error:', e); }
        }

        function setRecording(on) {
            if (on) {
                if (!stream) { console.error('Enable camera first.'); return; }
                if (typeof MediaRecorder === 'undefined') { console.error('MediaRecorder is not supported in this browser.'); return; }
                const mt = bestMime();
                chunks = [];
                recorder = new MediaRecorder(stream, { mimeType: mt, videoBitsPerSecond: 6_000_000 });
                recorder.ondataavailable = e => { if (e.data && e.data.size > 0) chunks.push(e.data); };
                recorder.onstop = handleTakeReady;
                recorder.start();
                S.recording = true;
                els.recBtn.classList.add('live');
                els.recBtn.textContent = '● LIVE';
                if (tcTimer) clearInterval(tcTimer);
                tcTimer = setInterval(stepTC, 1000 / Number(S.fps));
            } else {
                if (recorder && recorder.state !== 'inactive') recorder.stop();
                S.recording = false;
                els.recBtn.classList.remove('live');
                els.recBtn.textContent = '● REC';
                clearInterval(tcTimer);
                tcTimer = null;
            }
        }

        function safeName(s) { return s.replace(/[^\w\-]+/g, '_'); }
        function takeFilename() {
            const p = safeName(els.projName.textContent || 'Project');
            const c = safeName(els.clipId.textContent || 'Clip');
            const t = String(S.take).padStart(3, '0');
            const ts = new Date().toISOString().replace(/[:.]/g, '-');
            return `${p}_${c}_T${t}_${ts}.webm`;
        }

        async function handleTakeReady() {
            const blob = new Blob(chunks, { type: recorder.mimeType || 'video/webm' });
            const url = URL.createObjectURL(blob);
            const name = takeFilename();
            const meta = { name, size: blob.size, type: blob.type, fps: S.fps, iso: S.iso, shutter: S.shutter, ana: S.anamorphic, look: S.look, tc: tcStr() };
            if (saveDirHandle) {
                try {
                    const fileHandle = await saveDirHandle.getFileHandle(name, { create: true });
                    const w = await fileHandle.createWritable();
                    await w.write(blob);
                    await w.close();
                } catch (e) { console.warn('Folder save failed:', e); }
            }
            addTakeToBin({ url, blob, meta });
            if (!saveDirHandle) { triggerDownload(url, name); }
            S.take++;
            els.takeNo.textContent = S.take;
        }

        function triggerDownload(url, name) {
            const a = document.createElement('a');
            a.href = url;
            a.download = name;
            document.body.appendChild(a);
            a.click();
            a.remove();
        }

        function addTakeToBin(t) {
            takes.push(t);
            const row = document.createElement('div');
            row.className = 'take';
            const left = document.createElement('div');
            left.className = 'meta';
            left.innerHTML = `<strong>${t.meta.name}</strong>
                <span>(${(t.meta.size / 1e6).toFixed(2)} MB)</span>
                <span>TC ${t.meta.tc}</span>
                <span>${t.meta.fps}fps</span>
                <span>EI ${t.meta.iso}</span>
                <span>${t.meta.shutter}°</span>
                <span>${t.meta.ana === 1 ? 'Spherical' : t.meta.ana + 'x Anamorphic'}</span>
                <span>LOOK ${t.meta.look}</span>`;
            const vid = document.createElement('video');
            vid.src = t.url;
            vid.controls = true;
            vid.muted = true;
            vid.playsInline = true;
            const dl = document.createElement('button');
            dl.textContent = 'Download';
            dl.onclick = () => triggerDownload(t.url, t.meta.name);
            const del = document.createElement('button');
            del.textContent = 'Remove';
            del.onclick = () => { URL.revokeObjectURL(t.url); row.remove(); };
            row.append(left, dl, del);
            left.style.cursor = 'pointer';
            left.onclick = () => {
                if (row.querySelector('video')) { vid.remove(); } else { row.appendChild(vid); vid.play(); }
            };
            els.takeList.prepend(row);
        }
        
        function handleVoice(t) {
            if (/record|start/.test(t)) setRecording(true);
            if (/stop|cut/.test(t)) setRecording(false);
            const m = t.match(/fps\s*(\d{2,3})/);
            if (m) { S.fps = clamp(+m[1], 1, 600); els.fpsSel.value = String(S.fps); refreshBadges(); if (S.recording) { setRecording(false); setRecording(true) } }
            const n = t.match(/iso\s*(\d{2,5})/);
            if (n) { S.iso = clamp(+n[1], 160, 6400); els.iso.value = S.iso; refreshBadges(); updateExposure() }
            if (/anamorphic/.test(t)) {
                if (/1\.3|one point three|1 3/.test(t)) { S.anamorphic = 1.3 } else if (/2x|two/.test(t)) { S.anamorphic = 2 } else { S.anamorphic = 1 }
                els.anaSel.value = String(S.anamorphic);
                updateVisuals();
            }
            if (/look/.test(t)) {
                if (/classic/.test(t)) S.look = 'classic';
                else if (/filmic/.test(t)) S.look = 'filmic';
                else if (/raw/.test(t)) S.look = 'raw';
                els.lookSel.value = S.look;
                updateVisuals();
            }
            if (/focal/.test(t)) {
                if (/24/.test(t)) S.focalLength = 24;
                else if (/50/.test(t)) S.focalLength = 50;
                else if (/85/.test(t)) S.focalLength = 85;
                els.focalLengthSel.value = S.focalLength;
                updateVisuals();
            }
        }
        
        /* ---------- Events ---------- */
        els.resSel.onchange = e => { S.res = e.target.value; refreshBadges() }
        els.fpsSel.onchange = e => { S.fps = +e.target.value; refreshBadges(); if (S.recording) { setRecording(false); setRecording(true) } }
        els.aspSel.onchange = e => { S.aspect = e.target.value; applyAspect() }
        els.guides.onchange = applyAspect
        els.useCam.onclick = enableCam
        els.recBtn.onclick = () => setRecording(!S.recording)
        els.lookSel.onchange = e => { S.look = e.target.value; updateVisuals(); }
        els.texSel.onchange = e => { S.texture = e.target.value; applyTexture() }
        els.wbKel.oninput = e => { S.wb = +e.target.value; updateVisuals() }
        document.querySelectorAll('button[data-wb]').forEach(b => b.onclick = () => { S.wb = +b.dataset.wb; els.wbKel.value = S.wb; updateVisuals() })
        els.iso.oninput = e => { S.iso = clamp(+e.target.value, 160, 6400); refreshBadges(); updateExposure() }
        document.querySelector('.incIso').onclick = () => { S.iso = clamp(S.iso + 100, 160, 6400); els.iso.value = S.iso; refreshBadges(); updateExposure() }
        document.querySelector('.decIso').onclick = () => { S.iso = clamp(S.iso - 100, 160, 6400); els.iso.value = S.iso; refreshBadges(); updateExposure() }
        els.shutter.oninput = e => { S.shutter = clamp(+e.target.value, 45, 360); refreshBadges(); updateExposure() }
        document.querySelector('.incSh').onclick = () => { S.shutter = clamp(S.shutter + 5, 45, 360); els.shutter.value = S.shutter; refreshBadges(); updateExposure() }
        document.querySelector('.decSh').onclick = () => { S.shutter = clamp(S.shutter - 5, 45, 360); els.shutter.value = S.shutter; refreshBadges(); updateExposure() }
        els.anaSel.onchange = e => { S.anamorphic = +e.target.value; updateVisuals() }
        els.peakChk.onchange = e => { els.peaking.style.opacity = e.target.checked ? .6 : 0 }
        els.flareChk.onchange = e => { applyFlare() }
        els.focalLengthSel.onchange = e => { S.focalLength = +e.target.value; updateVisuals(); }
        els.captureGhost.onclick = () => { captureGhostFrame(); };
        els.ghostFrameChk.onchange = () => { updateVisuals(); };
        els.shotPlannerChk.onchange = () => { updateVisuals(); };
        els.micBtn.onclick = () => { 
            const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SR) { console.error('Roger: speech not supported'); return }
            let rec;
            rec = new SR();
            rec.continuous = true;
            rec.interimResults = false;
            rec.lang = 'en-US';
            rec.onstart = () => { els.micBtn.classList.add('on'); els.voiceStatus.textContent = 'Roger: listening…' }
            rec.onerror = e => { els.voiceStatus.textContent = 'Roger: '+e.error; rec.stop(); }
            rec.onend = () => { els.micBtn.classList.remove('on'); els.voiceStatus.textContent = 'Roger: idle'; }
            rec.onresult = (ev) => {
                const t=ev.results[ev.results.length-1][0].transcript.trim().toLowerCase();
                els.voiceStatus.textContent='Heard: "'+t+'"';
                handleVoice(t);
            };
            rec.start();
        }
        els.resetBtn.onclick = () => { localStorage.removeItem('merk_creative_kit'); location.reload() }
        els.saveBtn.onclick = () => { localStorage.setItem('merk_creative_kit', JSON.stringify(S)); blink(els.saveBtn) }
        els.chooseDir.onclick = chooseDir
        els.clearBin.onclick = () => { els.takeList.innerHTML = ''; takes.forEach(t => URL.revokeObjectURL(t.url)); takes = [] }

        function blink(btn) { btn.style.boxShadow = '0 0 12px rgba(122,240,255,.6)'; setTimeout(() => btn.style.boxShadow = '', 500) }

        /* ---------- Keyboard ---------- */
        window.addEventListener('keydown', e => {
            if (e.key.toLowerCase() === 'r') setRecording(!S.recording);
            if (e.key.toLowerCase() === 'a') {
                const seq = [1, 1.3, 2];
                const i = (seq.indexOf(S.anamorphic) + 1) % seq.length;
                S.anamorphic = seq[i];
                updateVisuals();
            }
            if (e.key.toLowerCase() === 'l') {
                const order = ['classic', 'filmic', 'raw'];
                const i = (order.indexOf(S.look) + 1) % order.length;
                S.look = order[i];
                els.lookSel.value = S.look;
                updateVisuals();
            }
            if (e.key === 'ArrowRight') {
                const fps = [24, 25, 30, 48, 60, 120, 600];
                let i = fps.indexOf(S.fps);
                i = (i + 1) % fps.length;
                S.fps = fps[i];
                els.fpsSel.value = S.fps;
                refreshBadges();
                if (S.recording) { setRecording(false); setRecording(true) }
            }
            if (e.key === 'ArrowLeft') {
                const fps = [24, 25, 30, 48, 60, 120, 600];
                let i = fps.indexOf(S.fps);
                i = (i - 1 + fps.length) % fps.length;
                S.fps = fps[i];
                els.fpsSel.value = S.fps;
                refreshBadges();
                if (S.recording) { setRecording(false); setRecording(true) }
            }
            if (e.key === 'ArrowUp') { S.iso = clamp(S.iso + 100, 160, 6400); els.iso.value = S.iso; refreshBadges(); updateExposure() }
            if (e.key === 'ArrowDown') { S.iso = clamp(S.iso - 100, 160, 6400); els.iso.value = S.iso; refreshBadges(); updateExposure() }
        });
        
        function captureGhostFrame() {
            if (!els.cam.srcObject) return;
            const canvas = document.createElement('canvas');
            const video = els.cam;
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageUrl = canvas.toDataURL('image/png');
            els.ghostFrame.style.backgroundImage = `url(${imageUrl})`;
        }
        
        /* ---------- Init ---------- */
        function init() {
            try {
                const M = JSON.parse(localStorage.getItem('merk_creative_kit') || 'null');
                if (M) Object.assign(S, M);
            } catch { }
            
            // Set initial state from S object
            els.resSel.value = S.res;
            els.fpsSel.value = String(S.fps);
            els.aspSel.value = S.aspect;
            els.lookSel.value = S.look;
            els.texSel.value = S.texture;
            els.wbKel.value = S.wb;
            els.iso.value = S.iso;
            els.shutter.value = S.shutter;
            els.anaSel.value = String(S.anamorphic);
            els.focalLengthSel.value = S.focalLength;
            els.batBar.style.width = S.battery + '%';
            els.batText.textContent = S.battery + '%';
            els.hotPct.textContent = S.hot + '%';
            els.warmPct.textContent = S.warm + '%';
            els.coldTB.textContent = S.coldTB.toFixed(1) + 'TB';

            updateVisuals();
            applyTexture();
            buildGrain();

            els.peaking.style.background = "repeating-linear-gradient(0deg, rgba(100,255,100,.0) 0 8px, rgba(100,255,100,.4) 8px 9px), repeating-linear-gradient(90deg, rgba(100,255,100,.0) 0 8px, rgba(100,255,100,.4) 8px 9px)";
            
            els.flareOverlay.innerHTML = `
                <svg width="100%" height="100%" viewBox="0 0 100 100" preserveAspectRatio="none">
                    <defs>
                        <linearGradient id="glowGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" style="stop-color:white;stop-opacity:0" />
                            <stop offset="25%" style="stop-color:white;stop-opacity:0.25" />
                            <stop offset="50%" style="stop-color:white;stop-opacity:0.6" />
                            <stop offset="75%" style="stop-color:white;stop-opacity:0.25" />
                            <stop offset="100%" style="stop-color:white;stop-opacity:0" />
                        </linearGradient>
                    </defs>
                    <rect x="0" y="49.5" width="100" height="1" fill="url(#glowGradient)"/>
                </svg>
            `;
        }
        window.addEventListener('resize', applyAspect);
        init();
    </script>
</body>
</html>
